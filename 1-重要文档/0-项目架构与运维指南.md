# 登泰劳保鞋独立站 - 项目架构与运维指南

> **版本**: v1.0  
> **更新日期**: 2026-02-01  
> **适用对象**: 项目管理者、开发人员、运维人员

---

## 📋 目录

1. [项目概览](#1-项目概览)
2. [整体架构](#2-整体架构)
3. [技术栈说明](#3-技术栈说明)
4. [部署架构](#4-部署架构)
5. [日常运维](#5-日常运维)
6. [内容更新流程](#6-内容更新流程)
7. [开发与上线流程](#7-开发与上线流程)
8. [故障排查](#8-故障排查)
9. [成本与扩展](#9-成本与扩展)

---

## 1. 项目概览

### 1.1 项目定位
登泰劳保鞋独立站是一个**现代化的多语言 B2B 营销网站**，采用 Headless CMS 架构，实现了内容管理与前端展示的完全分离。

### 1.2 核心特点
- 🌍 **多语言支持**: 中文/英文，易于扩展其他语言
- ⚡ **极速访问**: 采用 SSG 技术，全球 CDN 加速
- 📝 **内容管理**: 非技术人员可通过后台管理所有内容
- 🔄 **自动化部署**: 内容更新自动触发网站重新发布
- 💰 **低成本**: 前端托管免费，后端成本可控

### 1.3 主要功能模块
| 模块 | 功能 | 管理方式 |
|------|------|----------|
| 首页 | 品牌展示、产品推荐、新闻动态 | Strapi 后台 |
| 产品展示 | 产品列表、分类、详情、筛选 | Strapi 后台 |
| 关于我们 | 公司介绍、发展历程、认证资质 | 代码内容 |
| OEM 服务 | 定制流程、案例展示 | 代码内容 |
| FAQ | 常见问题解答 | 代码内容 |
| 询盘表单 | 客户咨询提交 | Strapi 后台查看 |

---

## 2. 整体架构

### 2.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户浏览器                            │
└────────────┬────────────────────────────┬───────────────────┘
             │                            │
             ▼                            ▼
    ┌────────────────┐          ┌────────────────┐
    │  Cloudflare     │          │  Cloudflare R2 │
    │  Pages (CDN)    │◄─────────┤  (图片存储)    │
    │  静态网站       │          └────────────────┘
    └────────────────┘
             │
             │ (构建时获取数据)
             ▼
    ┌────────────────┐          ┌────────────────┐
    │   云服务器      │          │   GitHub       │
    │  (VPS)         │          │   (代码仓库)    │
    ├────────────────┤          └────────────────┘
    │  Strapi CMS    │                   ▲
    │  (内容管理)     │                   │
    ├────────────────┤                   │
    │  PostgreSQL    │          ┌────────────────┐
    │  (数据库)      │          │   开发电脑      │
    └────────────────┘          └────────────────┘
```

### 2.2 三层架构说明

#### **第一层：前端展示层（用户访问）**
- **载体**: Cloudflare Pages（全球 CDN 节点）
- **形式**: 静态 HTML + JavaScript + CSS
- **特点**: 
  - 用户访问时从最近的 CDN 节点获取页面
  - 页面已预先生成，无需实时计算
  - 访问速度极快（通常 < 1 秒）

#### **第二层：内容管理层（运营使用）**
- **载体**: Strapi CMS（部署在云服务器）
- **访问**: http://43.165.0.206:3667/admin
- **功能**:
  - 产品管理（增删改查、图片上传）
  - 新闻管理（发布文章、视频）
  - 询盘查看（客户提交的咨询）
  - 用户权限管理

#### **第三层：数据存储层**
- **数据库**: PostgreSQL（存储产品、新闻、询盘等数据）
- **图片存储**: Cloudflare R2（类似于 AWS S3）
- **代码存储**: GitHub（版本控制）

---

## 3. 技术栈说明

### 3.1 前端技术
| 技术 | 版本 | 用途 | 为什么选择 |
|------|------|------|-----------|
| Next.js | 14.2 | React 框架 | SEO 友好，支持 SSG |
| TypeScript | 5.x | 类型安全 | 减少 bug，提高开发效率 |
| Tailwind CSS | 3.x | 样式框架 | 快速开发，易于维护 |
| next-intl | 3.x | 国际化 | 多语言支持 |

### 3.2 后端技术
| 技术 | 版本 | 用途 | 为什么选择 |
|------|------|------|-----------|
| Strapi | 5.x | Headless CMS | 开源，灵活，易用 |
| PostgreSQL | 16.x | 数据库 | 稳定可靠，功能强大 |
| Docker | 最新 | 容器化 | 简化部署，环境一致 |

### 3.3 部署服务
| 服务 | 提供商 | 用途 | 成本 |
|------|--------|------|------|
| 静态托管 | Cloudflare Pages | 前端网站 | 免费 |
| 图片存储 | Cloudflare R2 | 产品图片 | 免费额度充足 |
| 云服务器 | 腾讯云/阿里云 | Strapi 后台 | ¥50-200/月 |
| 代码托管 | GitHub | 版本控制 | 免费 |

---

## 4. 部署架构

### 4.1 前端部署（Cloudflare Pages）

#### **工作原理**
```
1. 开发者推送代码到 GitHub
2. Cloudflare 自动检测到更新
3. Cloudflare 拉取代码并构建
4. 构建过程中从 Strapi 获取最新数据
5. 生成静态 HTML 文件
6. 部署到全球 CDN 节点
```

#### **关键配置**
- **项目目录**: `safetyshoe-frontend/`
- **构建命令**: `npx next build`
- **输出目录**: `out/`
- **环境变量**:
  ```
  NEXT_PUBLIC_STRAPI_URL=http://43.165.0.206:3667
  NEXT_PUBLIC_SITE_URL=https://luyuan-2fl.pages.dev
  ```

#### **访问地址**
- 临时域名: https://luyuan-2fl.pages.dev
- 自定义域名: （待配置）

### 4.2 后端部署（云服务器）

#### **部署方式**
使用 Docker Compose 容器化部署，包含两个容器：
1. **strapi**: Strapi 应用服务
2. **postgres**: PostgreSQL 数据库

#### **服务器信息**
- **IP 地址**: 43.165.0.206
- **操作系统**: Linux（CentOS/Ubuntu）
- **端口映射**:
  - `3667` → Strapi 管理后台
  - `5432` → PostgreSQL（内部访问）

#### **关键配置**
- **数据持久化**: 使用 Docker Volume 确保数据不丢失
- **环境变量**: 
  ```
  DATABASE_NAME=safetyshoe
  DATABASE_USERNAME=strapi
  DATABASE_PASSWORD=******
  CLOUDFLARE_PUBLIC_URL=https://pub-xxx.r2.dev
  ```

#### **部署脚本**
位置: `deploy-backend-strapi.sh`
执行: `./deploy-backend-strapi.sh`

### 4.3 图片存储（Cloudflare R2）

#### **存储桶信息**
- **公共 URL**: https://pub-9a6ce20adf6d44c499aad464d60190a1.r2.dev
- **用途**: 存储产品图片、新闻图片
- **上传方式**: 通过 Strapi 后台上传时自动保存到 R2

#### **CORS 配置**
已配置跨域访问，确保图片可以在网站中正常显示（详见 `R2-CORS配置说明.md`）

---

## 5. 日常运维

### 5.1 日常检查清单

#### **每日检查**
- [ ] 网站是否正常访问（前端）
- [ ] Strapi 后台是否可登录
- [ ] 是否有新的客户询盘

#### **每周检查**
- [ ] 服务器磁盘空间（数据库、日志）
- [ ] Cloudflare Pages 构建记录
- [ ] 图片存储空间使用情况

#### **每月检查**
- [ ] 备份数据库
- [ ] 检查服务器安全更新
- [ ] 查看 Cloudflare 流量统计

### 5.2 监控指标

| 指标 | 正常范围 | 查看方式 | 异常处理 |
|------|----------|----------|----------|
| 网站响应时间 | < 2 秒 | 浏览器访问 | 检查 CDN 状态 |
| Strapi 响应时间 | < 1 秒 | 后台操作 | 重启服务 |
| 服务器 CPU | < 70% | SSH 登录查看 | 优化查询/扩容 |
| 服务器内存 | < 80% | SSH 登录查看 | 清理日志/扩容 |
| 数据库连接数 | < 50 | PostgreSQL 日志 | 检查连接泄漏 |

### 5.3 备份策略

#### **数据库备份**
- **频率**: 每天自动备份
- **保留**: 最近 30 天
- **方式**: 
  ```bash
  docker exec safetyshoe_postgres pg_dump -U strapi safetyshoe > backup.sql
  ```

#### **图片备份**
- Cloudflare R2 自动提供高可用性
- 建议每月同步一次到本地存储

#### **代码备份**
- GitHub 自动版本控制
- 每次提交都是一个备份点

---

## 6. 内容更新流程

### 6.1 产品管理流程

#### **添加新产品**
```
1. 登录 Strapi 后台
   └→ http://43.165.0.206:3667/admin

2. 进入 Content Manager → Products → Create new entry

3. 填写产品信息
   ├─ Name (产品名称)
   ├─ Model Code (型号)
   ├─ Description (描述)
   ├─ Safety Standard (安全标准: S1P, S3, etc.)
   ├─ Style (款式: Low Cut, High Boot)
   ├─ Industries (行业: Construction, Oil & Gas)
   ├─ MOQ (起订量)
   └─ Images (上传产品图片)

4. 点击 "Publish" 发布

5. 【自动触发】Cloudflare Pages 检测到数据变化
   └→ 开始重新构建网站 (约 2-5 分钟)

6. 构建完成后，新产品自动出现在网站上
```

#### **修改产品**
```
1. 在 Strapi 中找到要修改的产品
2. 点击编辑，修改内容
3. 点击 "Publish" 保存
4. 【自动触发】网站重新构建（同上）
```

#### **删除产品**
```
1. 在 Strapi 中找到产品
2. 点击 "Unpublish" 取消发布（产品仍保留在数据库）
   或
   点击 "Delete" 永久删除
3. 【自动触发】网站重新构建
```

### 6.2 新闻管理流程

同产品管理，在 `Content Manager → Factory Updates` 中操作。

### 6.3 询盘查看

```
1. 登录 Strapi 后台
2. Content Manager → Inquiries
3. 查看客户提交的询盘信息
4. 可导出为 CSV 或直接回复客户
```

### 6.4 自动化更新机制

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐
│  运营人员    │────>│  Strapi 后台  │────>│  Webhook     │
│  更新内容    │     │  (内容变化)   │     │  (触发信号)  │
└─────────────┘     └──────────────┘     └──────┬──────┘
                                                 │
                                                 ▼
                                        ┌─────────────────┐
                                        │ Cloudflare Pages │
                                        │  (自动重新构建)   │
                                        └────────┬────────┘
                                                 │
                                                 ▼
                                        ┌─────────────────┐
                                        │   网站更新完成   │
                                        │  (用户看到新内容) │
                                        └─────────────────┘
```

**时间线**: 从保存到上线约 2-5 分钟

---

## 7. 开发与上线流程

### 7.1 本地开发环境

#### **前端开发**
```bash
# 1. 进入前端目录
cd safetyshoe-frontend

# 2. 安装依赖（首次或更新时）
npm install

# 3. 启动开发服务器
npm run dev

# 4. 浏览器访问
http://localhost:3000
```

#### **后端开发**
```bash
# 1. 进入后端目录
cd safetyshoe-backend

# 2. 启动数据库（如果未运行）
docker-compose up -d postgres

# 3. 启动 Strapi
npm run develop

# 4. 浏览器访问
http://localhost:1337/admin
```

### 7.2 代码更新上线流程

#### **标准流程**（适用于功能开发、bug 修复）
```bash
# 1️⃣ 本地开发与测试
npm run dev          # 启动开发服务器
# 进行功能开发...
npm run build        # 本地构建测试
npx serve out        # 预览构建结果

# 2️⃣ 检查代码状态
git status           # 查看修改的文件
git diff             # 查看具体修改内容

# 3️⃣ 提交代码
git add .            # 添加所有修改
git commit -m "描述性的提交信息"  # 提交

# 4️⃣ 推送到 GitHub
git push origin main

# 5️⃣ 等待自动部署
# Cloudflare 自动检测到推送
# 自动构建并部署（约 2-5 分钟）
```

#### **提交信息规范**
```
feat: 添加新功能
fix: 修复 bug
docs: 文档更新
style: 样式调整
refactor: 代码重构
perf: 性能优化
test: 测试相关
chore: 构建/工具更新
```

### 7.3 版本管理

#### **分支策略**（推荐）
```
main (主分支)
├── 生产环境代码
└── 直接部署到 Cloudflare

develop (开发分支) - 可选
├── 开发中的功能
└── 测试通过后合并到 main
```

#### **查看版本历史**
```bash
git log --oneline -10     # 查看最近 10 次提交
git log --oneline --graph # 图形化查看提交历史
```

### 7.4 后端更新部署

```bash
# 1. 本地修改代码（如调整 Strapi 配置）

# 2. 测试无误后，使用部署脚本
./deploy-backend-strapi.sh

# 脚本会自动：
# - 连接到服务器
# - 上传最新代码
# - 重新构建 Docker 镜像
# - 重启服务
```

---

## 8. 故障排查

### 8.1 前端问题

#### **网站无法访问**
```
诊断步骤：
1. 检查 Cloudflare Pages 状态
   └→ https://dash.cloudflare.com/pages

2. 查看最近的构建记录
   └→ 是否有构建失败？

3. 检查自定义域名配置（如已配置）

4. 浏览器强制刷新（Ctrl+Shift+R）
```

#### **图片不显示**
```
诊断步骤：
1. 检查图片 URL 是否正确
   └→ 应该以 https:// 开头

2. 检查 R2 CORS 配置
   └→ 参考《R2-CORS配置说明.md》

3. 查看浏览器控制台错误信息
```

#### **构建失败**
```
诊断步骤：
1. 查看 Cloudflare 构建日志

2. 常见错误：
   ├─ TypeScript 错误 → 修复类型错误
   ├─ 环境变量缺失 → 检查 Cloudflare 配置
   ├─ API 连接失败 → 检查 Strapi 是否可访问
   └─ 依赖安装失败 → 检查 package.json

3. 本地重现：npm run build
```

### 8.2 后端问题

#### **Strapi 后台无法访问**
```
诊断步骤：
1. SSH 登录服务器
   └→ ssh root@43.165.0.206

2. 检查 Docker 容器状态
   └→ docker ps

3. 查看 Strapi 日志
   └→ docker logs safetyshoe_strapi

4. 重启服务（如需要）
   └→ docker-compose restart
```

#### **数据库连接失败**
```
诊断步骤：
1. 检查 PostgreSQL 容器是否运行
   └→ docker ps | grep postgres

2. 查看数据库日志
   └→ docker logs safetyshoe_postgres

3. 检查连接参数（在 .env 文件中）
```

#### **图片上传失败**
```
诊断步骤：
1. 检查 R2 配置
   └→ 环境变量: CLOUDFLARE_PUBLIC_URL

2. 检查 Strapi 插件配置
   └→ config/plugins.ts

3. 查看 Strapi 日志中的错误信息
```

### 8.3 常见错误速查

| 错误现象 | 可能原因 | 解决方案 |
|---------|---------|---------|
| 404 页面 | 路由配置错误 | 检查 Next.js 路由设置 |
| 图片 URL undefined | R2 配置缺失 | 设置 CLOUDFLARE_PUBLIC_URL |
| CORS 错误 | 跨域配置问题 | 配置 R2 CORS 规则 |
| 构建超时 | API 响应慢 | 优化 Strapi 查询性能 |
| TypeScript 错误 | 类型不匹配 | 检查接口定义 |

---

## 9. 成本与扩展

### 9.1 成本估算

#### **当前成本结构**
| 项目 | 月费用 | 说明 |
|------|--------|------|
| Cloudflare Pages | ¥0 | 免费托管 |
| Cloudflare R2 | ¥0 | 免费额度充足 |
| GitHub | ¥0 | 公开仓库免费 |
| 云服务器 | ¥50-200 | 根据配置 |
| **合计** | **¥50-200** | 极低成本 |

#### **流量增长后**
- Cloudflare Pages: 每月 500,000 次请求免费
- R2 存储: 10GB 免费存储
- 超出后按量付费，但成本仍然很低

### 9.2 扩展能力

#### **当前架构支持**
- ✅ 多语言扩展（已支持中英文，可轻松添加其他语言）
- ✅ 内容类型扩展（可在 Strapi 中添加新的内容类型）
- ✅ 功能模块扩展（前端 React 组件化，易于添加新功能）
- ✅ 全球访问加速（Cloudflare 全球 CDN）

#### **未来可扩展方向**
1. **在线商城**
   - 添加购物车功能
   - 集成支付网关
   - 订单管理系统

2. **用户系统**
   - 注册/登录
   - 个人中心
   - 询盘历史

3. **数据分析**
   - Google Analytics
   - 用户行为追踪
   - 转化率分析

4. **营销工具**
   - SEO 优化
   - 社交媒体分享
   - 邮件营销集成

### 9.3 性能优化建议

#### **已实施**
- ✅ 静态站点生成（SSG）
- ✅ 全球 CDN 加速
- ✅ 图片懒加载
- ✅ 代码分割
- ✅ CSS/JS 压缩

#### **可进一步优化**
- 🔄 图片格式优化（WebP）
- 🔄 关键资源预加载
- 🔄 Service Worker（PWA）
- 🔄 HTTP/3 支持

---

## 附录

### A. 关键文件说明

| 文件/目录 | 说明 |
|----------|------|
| `safetyshoe-frontend/` | 前端 Next.js 项目 |
| `safetyshoe-backend/` | 后端 Strapi 项目 |
| `deploy-backend-strapi.sh` | 后端部署脚本 |
| `1-重要文档/` | 项目文档目录 |
| `.env.local` | 本地开发环境变量 |
| `.env.production` | 生产环境变量 |
| `next.config.js` | Next.js 配置文件 |
| `docker-compose.yml` | Docker 编排配置 |

### B. 关键端口说明

| 端口 | 服务 | 访问方式 |
|------|------|----------|
| 3000 | Next.js 开发服务器 | http://localhost:3000 |
| 3001 | 静态文件预览 | http://localhost:3001 |
| 1337 | Strapi 本地开发 | http://localhost:1337 |
| 3667 | Strapi 生产环境 | http://43.165.0.206:3667 |
| 5434 | PostgreSQL 本地 | localhost:5434 |

### C. 相关文档索引

- [启动文件.md](./启动文件.md) - 快速启动指南
- [SSG静态页面上架指南.md](./SSG静态页面上架指南.md) - SSG 技术详解
- [多语言建设规范文档.md](./多语言建设规范文档.md) - 国际化规范
- [R2-CORS配置说明.md](./R2-CORS配置说明.md) - R2 配置指南
- [开发问题汇总.md](./开发问题汇总.md) - 常见问题与解决方案

### D. 联系与支持

| 需求 | 联系方式 |
|------|----------|
| 运维支持 | 开发团队 |
| 紧急问题 | 24小时内响应 |
| 功能定制 | 提前沟通排期 |

---

**文档维护**: 本文档应随项目更新而更新，建议每季度审查一次。
