# 开发问题汇总

## 1. Next.js 静态导出 404 问题（两层目录问题）

### 问题现象
- 访问 `/en` 或 `/zh` 路径时返回 404
- 本地预览 `npx serve out` 和 Cloudflare Pages 都无法访问
- `out` 目录缺少 `en/index.html` 和 `zh/index.html` 文件

### 根本原因
Next.js App Router 在 `output: 'export'` 静态导出模式下，对于动态路由 `[locale]`，需要满足以下条件才能正确生成静态页面：

1. **必须显式定义 `generateStaticParams()`**
   - 仅在父级 `layout.tsx` 定义还不够
   - 每个使用动态参数的 `page.tsx` 也需要显式定义

2. **需要正确的 `trailingSlash` 配置**
   - 没有此配置时，Next.js 可能生成 `en.html` 而不是 `en/index.html`
   - Cloudflare Pages 和大多数静态服务器期望的是目录+index.html 的结构

3. **数据获取策略必须兼容静态导出**
   - `cache: 'no-store'` 会触发动态渲染，导致静态导出失败
   - 必须使用 `next: { revalidate: X }` 或完全静态的 fetch

### 解决方案

#### 1. 在 `next.config.js` 中添加 `trailingSlash: true`
```javascript
module.exports = {
  output: 'export',
  trailingSlash: true, // 关键配置
  // ...
}
```

#### 2. 在 `src/app/[locale]/page.tsx` 中显式添加 `generateStaticParams`
```typescript
// 即使父级 layout.tsx 已经定义，page.tsx 也需要再次定义
export function generateStaticParams() {
  return [{ locale: 'en' }, { locale: 'zh' }];
}
```

#### 3. 修改所有 fetch 调用的缓存策略
在 `src/lib/strapi.ts` 中：
```typescript
// ❌ 错误 - 不兼容静态导出
fetch(url, { cache: 'no-store' })

// ✅ 正确 - 兼容静态导出
fetch(url, { next: { revalidate: 60 } })
```

#### 4. 创建根路径重定向页面
创建 `src/app/page.tsx` 处理 `/` 路径：
```typescript
import { redirect } from 'next/navigation';

export default function RootPage() {
  redirect('/en');
}
```

#### 5. 移除不兼容的配置
- 删除 `src/middleware.ts`（静态导出不支持中间件）
- 注释掉 `next.config.js` 中的 `async headers()`（静态导出不支持）

### 关键经验总结

1. **`generateStaticParams` 的作用域**
   - 在多层动态路由中，每一层都需要显式定义
   - 不能假设子路由会继承父路由的定义

2. **Next.js 静态导出的限制**
   - 不支持 middleware
   - 不支持自定义 headers、rewrites、redirects
   - 不支持 `cache: 'no-store'`
   - 所有动态路由必须在构建时确定

3. **调试技巧**
   - 使用 `npm run build` 后检查 `out` 目录结构
   - 使用 `npx serve out` 本地预览静态文件
   - 查看构建日志中的 "Generating static pages" 信息

### 相关文件
- `safetyshoe-frontend/next.config.js` - 添加 `trailingSlash: true`
- `safetyshoe-frontend/src/app/[locale]/page.tsx` - 添加 `generateStaticParams`
- `safetyshoe-frontend/src/app/[locale]/layout.tsx` - 定义 locale 参数
- `safetyshoe-frontend/src/app/page.tsx` - 根路径重定向
- `safetyshoe-frontend/src/lib/strapi.ts` - 修改 fetch 缓存策略

---

## 2. TypeScript 类型错误

### 问题
构建时出现多个类型错误，主要包括：
- 缺少 `Category`、`Inquiry` 等接口定义
- `IntlProvider` 的 `messages` 类型不匹配
- `next-intl` 消息结构类型不兼容

### 解决方案
1. 在 `src/types/index.ts` 中补充所有缺失的接口定义
2. 修改 `messages` 数组为对象结构以符合 `AbstractIntlMessages` 类型
3. 更新组件逻辑以适配新的消息对象结构

---

## 3. Docker 部署问题

### macOS 资源 fork 文件问题
**现象**：Docker 构建时出现 `Invalid or unexpected token` 错误

**原因**：macOS 会自动创建 `._*` 隐藏文件，这些文件被复制到 Docker 容器中导致错误

**解决方案**：
1. 在 `.dockerignore` 中添加 `._*`
2. 在 Dockerfile 中添加 `RUN find . -name '._*' -delete`
3. 在 rsync 命令中添加 `--exclude '._*'`

### Node.js 版本问题
Strapi 5 需要 Node.js 20+，确保 Dockerfile 使用正确的基础镜像：
```dockerfile
FROM node:20-alpine
```

---

## 4. 其他重要配置

### Cloudflare R2 CORS 配置
产品图片存储在 R2，需要配置 CORS 才能在前端和 Strapi 管理后台正常显示。
详见：`1-重要文档/R2-CORS配置说明.md`

### Strapi 自动产品填充
在 `src/index.ts` 中设置 `FORCE_RESET = false` 以禁用自动产品填充。

### 数据持久化
使用 Docker named volumes 确保数据库和上传文件在容器重启后保持：
```yaml
volumes:
  postgres_data:  # 数据库数据
  strapi_uploads: # 上传文件（如果使用本地存储）
```

---

**更新时间**：2026-02-01
